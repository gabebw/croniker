#!/bin/sh

set -e

stack install yesod-bin cabal-install --install-ghc
stack build
if ! psql -l | cut -d'|' -f1 | grep -qF croniker_development; then
  createdb croniker_development
fi

if ! command -v docker-compose > /dev/null; then
  echo "Install docker-compose"
  exit 1
fi

if ! heroku plugins | grep -Fq heroku-docker; then
  heroku plugins:install heroku-docker
fi

heroku git:remote --remote staging --app croniker-staging
heroku git:remote --remote production --app croniker-production

touch .env
for variable in TWITTER_CONSUMER_KEY TWITTER_CONSUMER_SECRET GOOGLE_API_KEY; do
  if ! grep -qF "$variable" .env; then
    heroku config --shell --remote staging | grep "$variable" >> .env
  fi
done

echo "Run the server: ./bin/run"
